// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
}

//////////////////// ENUMS ////////////////////

enum Role {
  ADMIN
  RECRUITER
  EMPLOYER
}

enum DocumentType {
  PASSPORT
  CV
  OTHER
}

//////////////////// USER ////////////////////

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())

  taskLogs  TaskLog[]
}

//////////////////// EMPLOYER ////////////////////

model Employer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  company   String
  createdAt DateTime @default(now())

  jobs      Job[]
}

//////////////////// CANDIDATE ////////////////////

model Candidate {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  firstName        String
  lastName         String
  email            String
  postcode         String
  country          String
  passportExpiry   DateTime?
  complianceScore  Int      @default(0)
  isAssignable     Boolean  @default(false)

  createdById      String   @db.ObjectId
  createdAt        DateTime @default(now())
  deletedAt        DateTime?

  documents        Document[]
  assignments      Assignment[]
  notes            Note[]
  tags             CandidateTag[]
  taskLogs         TaskLog[]
}

//////////////////// JOB ////////////////////

model Job {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  employerId  String   @db.ObjectId
  createdAt   DateTime @default(now())

  employer    Employer @relation(fields: [employerId], references: [id])
  assignments Assignment[]
}

//////////////////// ASSIGNMENT ////////////////////

model Assignment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  candidateId String   @db.ObjectId
  jobId       String   @db.ObjectId
  assignedAt  DateTime @default(now())

  candidate   Candidate @relation(fields: [candidateId], references: [id])
  job         Job       @relation(fields: [jobId], references: [id])
}

//////////////////// DOCUMENT ////////////////////

model Document {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  candidateId String       @db.ObjectId
  type        DocumentType
  fileUrl     String
  uploadedAt  DateTime     @default(now())

  candidate   Candidate @relation(fields: [candidateId], references: [id])
}

//////////////////// NOTES ////////////////////

model Note {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  candidateId String   @db.ObjectId
  content     String
  createdAt   DateTime @default(now())

  candidate   Candidate @relation(fields: [candidateId], references: [id])
}

//////////////////// TAGS ////////////////////

model Tag {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  name       String         @unique
  candidates CandidateTag[]
}

model CandidateTag {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  candidateId String   @db.ObjectId
  tagId       String   @db.ObjectId

  candidate   Candidate @relation(fields: [candidateId], references: [id])
  tag         Tag       @relation(fields: [tagId], references: [id])
}

//////////////////// TASK LOG ////////////////////

model TaskLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  action      String
  userId      String   @db.ObjectId
  candidateId String?  @db.ObjectId
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  candidate   Candidate? @relation(fields: [candidateId], references: [id])
}

//////////////////// COMPLIANCE RULE ENGINE ////////////////////

model ComplianceRule {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  field       String   // country, passportExpiry, etc
  condition   String   // equals, less_than, required
  value       String   // UK, IE, 6months, etc
  message     String
}
